#include <FL/Fl.H>
#include <FL/Fl_Window.H>
#include <FL/Fl_Input.H>
#include <FL/Fl_Secret_Input.H>
#include <FL/Fl_Button.H>
#include <FL/fl_message.H>

//assumes credentials, would pull from database/known authorization offline key
const char *correctUser = "user";
const char *correctPass = "pass";
const char *correctKey = "key";

const char MAX_ATTEMPTS = 3;

//data for login
struct CallbackData {
    Fl_Input *inputUsername;
    Fl_Secret_Input *inputPassword;
    Fl_Secret_Input *inputSecretKey;
    Fl_Window *window;
    int attempts;
};

void submit_callback(Fl_Widget *widget, void *data) {
    CallbackData *callbackData = static_cast<CallbackData *>(data);

    //destination buffers are large enough
    char username[256];
    char password[256];
    char secretKey[256];

    //copy user input to destination buffers
    strncpy(username, callbackData->inputUsername->value(), sizeof(username) - 1);
    strncpy(password, callbackData->inputPassword->value(), sizeof(password) - 1);
    strncpy(secretKey, callbackData->inputSecretKey->value(), sizeof(secretKey) - 1);

    //null-terminate the strings to ensure proper string handling
    username[sizeof(username) - 1] = '\0';
    password[sizeof(password) - 1] = '\0';
    secretKey[sizeof(secretKey) - 1] = '\0';

    //data handling
    
    if(strcmp(username, correctUser) == 0 && strcmp(password, correctPass) == 0 && strcmp(secretKey, correctKey) == 0){
        fl_message("Access Granted\nEnjoy your flight!");
        callbackData->window->hide();
    }
    else{
        ++callbackData->attempts;
        if(callbackData->attempts >= MAX_ATTEMPTS){
            fl_message("Access Denied\nExceeded maximum number of attempts");
            callbackData->window->hide();
        }
        else{
            fl_message("Access Denied\nIncorrect credentials, try again.");
        }
    }
}

int main() {
    Fl_Window *window = new Fl_Window(300, 200, "Enter Credentials");

    Fl_Input *inputUsername = new Fl_Input(100, 20, 180, 30, "Username:");
    Fl_Secret_Input *inputPassword = new Fl_Secret_Input(100, 60, 180, 30, "Password:");
    Fl_Secret_Input *inputSecretKey = new Fl_Secret_Input(100, 100, 180, 30, "Secret Key:");

    CallbackData callbackData = {inputUsername, inputPassword, inputSecretKey, window, 0};

    Fl_Button *submitButton = new Fl_Button(120, 150, 60, 30, "Submit");
    submitButton->callback(submit_callback, &callbackData);

    window->end();
    window->show();

    return Fl::run();
}